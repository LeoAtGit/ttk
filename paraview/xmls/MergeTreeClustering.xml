<?xml version="1.0" encoding="UTF-8"?>

<!-- Add widgets to the ParaView UI that control the member variables of the vtk filter -->

<!-- NOTE: Unfortunately the widget types and their properties are not well documented. -->
<!--       The best thing you can do is to look at filters that have similar widgets you require and copy their source code. -->
<!--       Good resources are: IcoSphere.xml, PersistenceDiagram.xml, and ArrayEditor.xml -->

<ServerManagerConfiguration>
    <ProxyGroup name="filters">
        <SourceProxy name="MergeTreeClustering" 
                     class="ttkMergeTreeClustering" 
                     label="TTK MergeTreeClustering">
           <Documentation long_help="TTK MergeTreeClustering plugin that compute distance, geodesics and barycenters between merge trees." 
                          short_help="TTK MergeTreeClustering plugin that compute distance, geodesics and barycenters between merge trees.">
               TTK MergeTreeClustering plugin documentation.
               
               Related publication:
               R. Sridharamurthy, T. B. Masood, A. Kamakshidasan, and V. Natarajan.
               Edit distance between merge trees. 
               IEEE Transactions on Visualization and Computer Graphics, 2018.
               
               M. Pont, J. Vidal, J. Delon, J. Tierny.
               Wasserstein Distances, Geodesics and Barycenters of Merge Trees.
               IEEE VIS 2021.
           </Documentation>

            <!-- INPUT -->
           
                <InputProperty
                    name="Input"
                    port_index="0"
                    command="SetInputConnection">
                  <ProxyGroupDomain name="groups">
                    <Group name="sources"/>
                    <Group name="filters"/>
                  </ProxyGroupDomain>
                  <DataTypeDomain name="input_type">
                    <DataType value="vtkMultiBlockDataSet"/>
                  </DataTypeDomain>
                  <InputArrayDomain name="input_scalars" number_of_components="1">
                    <Property name="Input" function="FieldDataSelection" />
                  </InputArrayDomain>
                  <Documentation>
                    Merge trees to process.
                  </Documentation>
                </InputProperty>
                
                <InputProperty
                    name="Input2 (optionnal, only for clustering)"
                    port_index="1"
                    command="SetInputConnection">
                  <ProxyGroupDomain name="groups">
                    <Group name="sources"/>
                    <Group name="filters"/>
                  </ProxyGroupDomain>
                  <DataTypeDomain name="input_type">
                    <DataType value="vtkMultiBlockDataSet"/>
                  </DataTypeDomain>
                  <InputArrayDomain name="input_scalars" number_of_components="1">
                    <Property name="Input" function="FieldDataSelection" />
                  </InputArrayDomain>
                  <Documentation>
                    This input is used for the clustering of merge trees that can use join and split tree together. Pass as input either join or split trees in the first input and the other type of trees in the second input.
                  </Documentation>
                </InputProperty>

            <!-- INPUT PARAMETER WIDGETS -->
                <!-- Execution options -->
                <IntVectorProperty
                name="Backend"
                label="Backend"
                command="SetBackend"
                number_of_elements="1"
                default_values="0">
                <EnumerationDomain name="enum">
                    <Entry value="0" text="Wasserstein Distance (IEEE TVCG 2021)"/>
                    <Entry value="1" text="Edit Distance (IEEE TVCG 2019)"/>
                    <Entry value="2" text="Custom"/>
                </EnumerationDomain>
                  <Documentation>
                  </Documentation>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="BranchDecomposition"
                command="SetBranchDecomposition"
                label="Use Branch Decomposition"
                number_of_elements="1"
                default_values="1">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="Backend"
                                           value="2" />
                  </Hints>
                  <Documentation>
                    Use branch decomposition representation.
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="NormalizedWasserstein"
                command="SetNormalizedWasserstein"
                label="Normalized Wasserstein"
                number_of_elements="1"
                default_values="1">
                  <Hints>
                  <PropertyWidgetDecorator type="CompositeDecorator">
                    <Expression type="and">
                      <PropertyWidgetDecorator type="GenericDecorator"
                                              mode="visibility"
                                              property="BranchDecomposition"
                                              value="1" />
                      <PropertyWidgetDecorator type="GenericDecorator"
                                              mode="visibility"
                                              property="Backend"
                                              value="2" />
                    </Expression>
                  </PropertyWidgetDecorator>
                  </Hints>
                  <Documentation>
                    Use normalized Wasserstein (set to true to have a consistent barycenter of merge trees).
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="KeepSubtree"
                command="SetKeepSubtree"
                label="Keep Subtree"
                number_of_elements="1"
                default_values="0">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="Backend"
                                           value="2" />
                  </Hints>
                  <Documentation>
                    Keep subtree when destroying/inserting a node (set to false to have a consistent barycenter of merge tree).
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>  
                
                <IntVectorProperty
                name="ComputeBarycenter"
                command="SetComputeBarycenter"
                label="Compute Barycenter"
                number_of_elements="1"
                default_values="0">
                  <Hints>
                  <PropertyWidgetDecorator type="CompositeDecorator">
                    <Expression type="or">
                      <Expression type="and">
                        <Expression type="and">
                          <PropertyWidgetDecorator type="GenericDecorator"
                                                  mode="visibility"
                                                  property="BranchDecomposition"
                                                  value="1" />
                          <PropertyWidgetDecorator type="GenericDecorator"
                                                  mode="visibility"
                                                  property="Backend"
                                                  value="2" />
                        </Expression>
                        <PropertyWidgetDecorator type="GenericDecorator"
                                                mode="visibility"
                                                property="KeepSubtree"
                                                value="0" />
                      </Expression>
                      <PropertyWidgetDecorator type="GenericDecorator"
                                              mode="visibility"
                                              property="Backend"
                                              value="0" />
                    </Expression>
                  </PropertyWidgetDecorator>
                  </Hints>
                  <Documentation>
                    Compute a barycenter of the merge trees in input.
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="NumberOfBarycenters"
                command="SetNumberOfBarycenters"
                label="Number Of Barycenters"
                number_of_elements="1"
                default_values="1">
                  <Hints>
                  <PropertyWidgetDecorator type="CompositeDecorator">
                    <Expression type="and">
                      <Expression type="and">
                        <Expression type="or">
                          <Expression type="and">
                            <PropertyWidgetDecorator type="GenericDecorator"
                                                    mode="visibility"
                                                    property="BranchDecomposition"
                                                    value="1" />
                            <PropertyWidgetDecorator type="GenericDecorator"
                                                    mode="visibility"
                                                    property="Backend"
                                                    value="2" />
                          </Expression>
                          <PropertyWidgetDecorator type="GenericDecorator"
                                                  mode="visibility"
                                                  property="Backend"
                                                  value="0" />
                        </Expression>
                        <PropertyWidgetDecorator type="GenericDecorator"
                                                mode="visibility"
                                                property="KeepSubtree"
                                                value="0" />
                      </Expression>
                      <PropertyWidgetDecorator type="GenericDecorator"
                                              mode="visibility"
                                              property="ComputeBarycenter"
                                              value="1" />
                    </Expression>
                  </PropertyWidgetDecorator>
                  </Hints>
                  <Documentation>
                    Number of barycenter to compute (performs a KMeans with merge trees as centroids).
                  </Documentation>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="Deterministic"
                command="SetDeterministic"
                label="Deterministic"
                number_of_elements="1"
                default_values="0">
                  <Documentation>
                    
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="AssignmentSolver"
                label="Assignment Solver"
                command="SetAssignmentSolver"
                number_of_elements="1"
                default_values="0">
                <EnumerationDomain name="enum">
                    <Entry value="0" text="Auction"/>
                    <Entry value="1" text="Exhaustive Search"/>
                    <Entry value="2" text="Munkres"/>
                </EnumerationDomain>
                  <Documentation>
                  </Documentation>
                </IntVectorProperty>
                
                <DoubleVectorProperty
                name="Alpha"
                command="SetAlpha"
                label="Alpha"
                number_of_elements="1"
                default_values="0.5"
                panel_visibility="advanced">>
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="ComputeBarycenter"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Set the alpha coefficent of the first tree. Use to work when there is only 2 input trees, the alpha of the second input will be (1-alpha).
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="1" />
                </DoubleVectorProperty> 
                
                <DoubleVectorProperty
                name="JoinSplitMixtureCoefficient"
                command="SetJoinSplitMixtureCoefficient"
                label="Join Split Mixture Coefficient"
                number_of_elements="1"
                default_values="0.5"
                panel_visibility="advanced">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="ComputeBarycenter"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    When Input2 is filled, either it contains split tree and Input1 join tree or the other way around. This parameter allows to ponderate more or less the second input or the first one in the computation of the barycenter.
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="1" />
                </DoubleVectorProperty>
                
                <!-- Input options -->
                <!-- TODO <IntVectorProperty
                name="UseMinMaxPair"
                command="SetUseMinMaxPair"
                label="Use Min Max Pair"
                number_of_elements="1"
                default_values="1"
                panel_visibility="advanced">
                <Documentation>
                    
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty> -->
                
                <IntVectorProperty
                name="DeleteMultiPersPairs"
                command="SetDeleteMultiPersPairs"
                label="Delete Multi Pers. Pairs"
                number_of_elements="1"
                default_values="0"
                panel_visibility="advanced">
                  <Documentation>
                    Delete persistence pairs for which the saddle point is involved in more than one pair.
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="Epsilon1UseFarthestSaddle"
                command="SetEpsilon1UseFarthestSaddle"
                label="Epsilon1 Use Farthest Saddle"
                number_of_elements="1"
                default_values="0"
                panel_visibility="advanced">
                  <Documentation>
                    
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <DoubleVectorProperty
                name="EpsilonTree1"
                command="SetEpsilonTree1"
                label="Epsilon 1 (%)"
                number_of_elements="1"
                default_values="5">
                  <Documentation>
                    Merge saddle points (in a bottom-up manner) having their difference in function value below epsilon times the biggest difference in function value. No effect for epsilon = 0.
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="100" />
                </DoubleVectorProperty>   
                
                <DoubleVectorProperty
                name="Epsilon2Tree1"
                command="SetEpsilon2Tree1"
                label="Epsilon 2 (%)"
                number_of_elements="1"
                default_values="95"
                panel_visibility="advanced">
                  <Hints>
                  <PropertyWidgetDecorator type="CompositeDecorator">
                    <Expression type="or">
                      <Expression type="and">
                        <PropertyWidgetDecorator type="GenericDecorator"
                                                mode="visibility"
                                                property="BranchDecomposition"
                                                value="1" />
                        <PropertyWidgetDecorator type="GenericDecorator"
                                                mode="visibility"
                                                property="Backend"
                                                value="2" />
                      </Expression>
                      <PropertyWidgetDecorator type="GenericDecorator"
                                              mode="visibility"
                                              property="Backend"
                                              value="0" />
                    </Expression>
                  </PropertyWidgetDecorator>
                  </Hints>
                  <Documentation>
                    Given a branch decomposition, ascend a pair (by making it children of the parent of its parent) if the ratio between its persistence and the persistence of its parent is above epsilon2. A high value will ascend only pairs having a close persistence to their parent, more epsilon2 is low more the pairs having a distant persistence to their parent will also be ascended. No effect for epsilon2 = 100.
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="100" />
                </DoubleVectorProperty>   
                
                <DoubleVectorProperty
                name="Epsilon3Tree1"
                command="SetEpsilon3Tree1"
                label="Epsilon 3 (%)"
                number_of_elements="1"
                default_values="90"
                panel_visibility="advanced">
                  <Hints>
                  <PropertyWidgetDecorator type="CompositeDecorator">
                    <Expression type="or">
                      <Expression type="and">
                        <PropertyWidgetDecorator type="GenericDecorator"
                                                mode="visibility"
                                                property="BranchDecomposition"
                                                value="1" />
                        <PropertyWidgetDecorator type="GenericDecorator"
                                                mode="visibility"
                                                property="Backend"
                                                value="2" />
                      </Expression>
                      <PropertyWidgetDecorator type="GenericDecorator"
                                              mode="visibility"
                                              property="Backend"
                                              value="0" />
                    </Expression>
                  </PropertyWidgetDecorator>
                  </Hints>
                  <Documentation>
                    Will apply the processing of Epsilon2 only for the pairs having a ratio between their persistence and the maximum persistence inferior to epsilon3. A low value will apply the processing of Epsilon2 only to the small persistence pairs, more epsilon3 is high more the pairs having a high persistence will also be processed. No effect for epsilon3 = 100.
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="100" />
                </DoubleVectorProperty>
                
                <DoubleVectorProperty
                name="PersistenceThreshold"
                command="SetPersistenceThreshold"
                label="Persistence Threshold (%)"
                number_of_elements="1"
                default_values="0">
                  <Documentation>
                    
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="100" />
                </DoubleVectorProperty>  
                
                <!-- Output options -->
                
                <IntVectorProperty
                name="OutputTrees"
                command="SetOutputTrees"
                label="Output Trees"
                number_of_elements="1"
                default_values="1">
                  <Documentation>
                    Display output trees. 
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <DoubleVectorProperty
                name="DimensionSpacing"
                command="SetDimensionSpacing"
                label="Dimension Spacing"
                number_of_elements="1"
                default_values="1.0">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="OutputTrees"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    
                  </Documentation>
                </DoubleVectorProperty>
                
                <IntVectorProperty
                name="DimensionToShift"
                label="Dimension To shift"
                command="SetDimensionToShift"
                number_of_elements="1"
                default_values="0"
                panel_visibility="advanced">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="OutputTrees"
                                           value="1" />
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="0" />
                  </Hints>
                <EnumerationDomain name="enum">
                    <Entry value="0" text="X"/>
                    <Entry value="1" text="Y"/>
                    <Entry value="2" text="Z"/>
                </EnumerationDomain>
                  <Documentation>
                  </Documentation>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="BarycenterPositionAlpha"
                command="SetBarycenterPositionAlpha"
                label="Barycenter position according alpha"
                number_of_elements="1"
                default_values="0"
                panel_visibility="advanced">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="OutputTrees"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Position barycenter according alpha parameter (when 2 input trees).
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="PlanarLayout"
                command="SetPlanarLayout"
                label="Planar Layout"
                number_of_elements="1"
                default_values="1">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="OutputTrees"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Display trees in a plane or in the original domain.
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="BranchDecompositionPlanarLayout"
                command="SetBranchDecompositionPlanarLayout"
                label="Branch Decomposition Planar Layout"
                number_of_elements="1"
                default_values="0"
                panel_visibility="advanced">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Display a planar layout of the branch decomposition (each node is a branch in the original tree).
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <DoubleVectorProperty
                name="BranchSpacing"
                command="SetBranchSpacing"
                label="Branch Spacing"
                number_of_elements="1"
                default_values="1">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="1" />
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="BranchDecompositionPlanarLayout"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Manage the distance between branch in the branch decomposition planar layout.
                  </Documentation>
                </DoubleVectorProperty>
                
                <DoubleVectorProperty
                name="ImportantPairs"
                command="SetImportantPairs"
                label="Important Pairs (%)"
                number_of_elements="1"
                default_values="10">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Threshold to consider a persistence pair as important. They will be displayed such that they are much more visible than the rest.
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="100" />
                </DoubleVectorProperty>
                
                <DoubleVectorProperty
                name="ImportantPairsSpacing"
                command="SetImportantPairsSpacing"
                label="Important Pairs Spacing"
                number_of_elements="1"
                default_values="1">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Manage the distance of the important pairs with each other.
                  </Documentation>
                </DoubleVectorProperty>
                
                <DoubleVectorProperty
                name="NonImportantPairsSpacing"
                command="SetNonImportantPairsSpacing"
                label="Non Important Pairs Spacing"
                number_of_elements="1"
                default_values="0.1">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Manage the distance of the non-important pairs with each other.
                  </Documentation>
                </DoubleVectorProperty>
                
                <DoubleVectorProperty
                name="NonImportantPairsProximity"
                command="SetNonImportantPairsProximity"
                label="Non Important Pairs Proximity"
                number_of_elements="1"
                default_values="0.05">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Manage the distance of the non-important pairs to the important pairs they are attached to.
                  </Documentation>
                  <DoubleRangeDomain name="range" min="0" max="1" />
                </DoubleVectorProperty>
                
                <IntVectorProperty
                name="RescaleTreesIndividually"
                command="SetRescaleTreesIndividually"
                label="Rescale Trees Individually"
                number_of_elements="1"
                default_values="0"
                panel_visibility="advanced">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="1" />
                  </Hints>
                  <Documentation>
                    Rescale trees individually. If enabled, the trees will have the same size, it can be interesting to use to individually analyze trees but the comparison between trees given their size will be biased.
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>
                
                <IntVectorProperty
                name="OutputSegmentation"
                command="SetOutputSegmentation"
                label="Output Segmentation"
                number_of_elements="1"
                default_values="0">
                  <Hints>
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="OutputTrees"
                                           value="1" />
                  <PropertyWidgetDecorator type="GenericDecorator"
                                           mode="visibility"
                                           property="PlanarLayout"
                                           value="0" />
                  </Hints>
                  <Documentation>
                    Display output segmentation. Be careful, it can consume a lot of memory since some segmentations must be copied (to shift them).
                  </Documentation>
                  <BooleanDomain name="bool"/>
                </IntVectorProperty>  
            
            <PropertyGroup panel_widget="Line" label="Execution options">
              <Property name="Backend"/>
              <Property name="BranchDecomposition"/>
              <Property name="NormalizedWasserstein"/>
              <Property name="KeepSubtree"/>
              <Property name="ComputeBarycenter"/>
              <Property name="NumberOfBarycenters"/>
              <Property name="Deterministic"/>
              <Property name="AssignmentSolver"/>
              <Property name="Alpha"/>
              <Property name="JoinSplitMixtureCoefficient"/>
            </PropertyGroup>
            
            <PropertyGroup panel_widget="Line" label="Input options">
              <!-- <Property name="UseMinMaxPair"/> -->
              <Property name="DeleteMultiPersPairs"/>
              <Property name="Epsilon1UseFarthestSaddle"/>
              <Property name="EpsilonTree1"/>
              <Property name="Epsilon2Tree1"/>
              <Property name="Epsilon3Tree1"/>
              <Property name="PersistenceThreshold"/>
            </PropertyGroup>
                
            <PropertyGroup panel_widget="Line" label="Output options">
              <Property name="OutputTrees"/>
              <Property name="DimensionSpacing"/>
              <Property name="DimensionToShift"/>
              <Property name="BarycenterPositionAlpha"/>
              <Property name="PlanarLayout"/>
              <Property name="BranchDecompositionPlanarLayout"/>
              <Property name="BranchSpacing"/>
              <Property name="ImportantPairs"/>
              <Property name="ImportantPairsSpacing"/>
              <Property name="NonImportantPairsSpacing"/>
              <Property name="NonImportantPairsProximity"/>
              <Property name="RescaleTreesIndividually"/>
              <Property name="OutputSegmentation"/>
            </PropertyGroup>

            <!-- OUTPUT PARAMETER WIDGETS -->
                <OutputPort name="Clustered Merge Trees" index="0" id="port0" />
                <OutputPort name="Centroids Merge Trees" index="1" id="port1" />
                <OutputPort name="Matchings" index="2" id="port2" />

            <!-- DEBUG -->
            ${DEBUG_WIDGETS}

            <!-- MENU CATEGORY -->
                <Hints>
                    <ShowInMenu category="TTK - Ensemble Scalar Data" />
                </Hints>
        </SourceProxy>
    </ProxyGroup>
</ServerManagerConfiguration>
